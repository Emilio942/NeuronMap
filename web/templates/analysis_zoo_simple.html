{% extends "base.html" %}

{% block title %}Analysis Zoo - NeuronMap{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-4">
                        <i class="fas fa-university text-primary me-3"></i>
                        Analysis Zoo
                    </h1>
                    <p class="lead text-muted">
                        Community platform for sharing and discovering neural network analysis artifacts
                    </p>
                </div>
                <div>
                    <button class="btn btn-primary btn-lg me-2" onclick="uploadArtifact()">
                        <i class="fas fa-upload me-2"></i>Upload Artifact
                    </button>
                    <button class="btn btn-outline-primary btn-lg" onclick="refreshArtifacts()">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="searchQuery" class="form-label">Search Artifacts</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchQuery" 
                                       placeholder="Search by name, tags, or description...">
                                <button class="btn btn-outline-secondary" onclick="searchArtifacts()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="typeFilter" class="form-label">Type</label>
                            <select class="form-select" id="typeFilter" onchange="filterArtifacts()">
                                <option value="">All Types</option>
                                <option value="sae_model">SAE Models</option>
                                <option value="circuit">Circuits</option>
                                <option value="analysis_result">Analysis Results</option>
                                <option value="dataset">Datasets</option>
                                <option value="visualization">Visualizations</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="modelFilter" class="form-label">Model</label>
                            <select class="form-select" id="modelFilter" onchange="filterArtifacts()">
                                <option value="">All Models</option>
                                <option value="gpt2">GPT-2</option>
                                <option value="gpt2-medium">GPT-2 Medium</option>
                                <option value="gpt2-large">GPT-2 Large</option>
                                <option value="llama-2-7b">Llama-2-7B</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sortBy" class="form-label">Sort By</label>
                            <select class="form-select" id="sortBy" onchange="sortArtifacts()">
                                <option value="updated_at">Recently Updated</option>
                                <option value="created_at">Recently Created</option>
                                <option value="downloads">Most Downloaded</option>
                                <option value="stars">Most Starred</option>
                                <option value="name">Name</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="viewMode" class="form-label">View</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="gridView" checked>
                                <label class="btn btn-outline-secondary" for="gridView">
                                    <i class="fas fa-th-large"></i>
                                </label>
                                <input type="radio" class="btn-check" name="viewMode" id="listView">
                                <label class="btn btn-outline-secondary" for="listView">
                                    <i class="fas fa-list"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Artifacts Grid -->
            <div id="artifactsContainer">
                <div class="row" id="artifactsGrid">
                    <!-- Artifacts will be loaded here -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading artifacts...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading artifacts from the Analysis Zoo...</p>
                    </div>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="row mt-5">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h2 class="text-primary" id="totalArtifacts">-</h2>
                            <p class="card-text">Total Artifacts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h2 class="text-success" id="totalDownloads">-</h2>
                            <p class="card-text">Total Downloads</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h2 class="text-warning" id="totalAuthors">-</h2>
                            <p class="card-text">Contributors</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h2 class="text-info" id="totalModels">-</h2>
                            <p class="card-text">Supported Models</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Artifact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="artifactName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="artifactName" required>
                    </div>
                    <div class="mb-3">
                        <label for="artifactType" class="form-label">Type</label>
                        <select class="form-select" id="artifactType" required>
                            <option value="">Select type...</option>
                            <option value="sae_model">SAE Model</option>
                            <option value="circuit">Circuit</option>
                            <option value="analysis_result">Analysis Result</option>
                            <option value="dataset">Dataset</option>
                            <option value="visualization">Visualization</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="artifactDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="artifactDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="artifactFile" class="form-label">File</label>
                        <input type="file" class="form-control" id="artifactFile" required>
                    </div>
                    <div class="mb-3">
                        <label for="artifactTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="artifactTags" 
                               placeholder="comma, separated, tags">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitUpload()">Upload</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Analysis Zoo JavaScript functionality
let artifacts = [];
let filteredArtifacts = [];

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadArtifacts();
    loadStats();
});

// Load artifacts from API
async function loadArtifacts() {
    try {
        showLoading(true);
        const response = await fetch('/api/zoo/search');
        if (response.ok) {
            artifacts = await response.json();
            filteredArtifacts = [...artifacts];
            renderArtifacts();
        } else {
            // Show demo data if API is not available
            loadDemoArtifacts();
        }
    } catch (error) {
        console.error('Error loading artifacts:', error);
        loadDemoArtifacts();
    } finally {
        showLoading(false);
    }
}

// Load demo artifacts for display
function loadDemoArtifacts() {
    artifacts = [
        {
            uuid: '1',
            name: 'GPT-2 Layer 8 SAE',
            artifact_type: 'sae_model',
            description: 'Sparse autoencoder trained on GPT-2 layer 8 MLP activations',
            authors: [{name: 'Research Team', email: 'team@example.com'}],
            version: '1.0.0',
            tags: ['gpt2', 'sae', 'layer8', 'mlp'],
            downloads: 145,
            stars: 23,
            created_at: '2025-06-20T10:00:00Z',
            updated_at: '2025-06-28T15:30:00Z'
        },
        {
            uuid: '2',
            name: 'Induction Head Circuit',
            artifact_type: 'circuit',
            description: 'Complete analysis of induction head mechanisms in transformer models',
            authors: [{name: 'Circuit Team', email: 'circuits@example.com'}],
            version: '2.1.0',
            tags: ['induction', 'circuits', 'gpt2', 'attention'],
            downloads: 89,
            stars: 17,
            created_at: '2025-06-15T14:20:00Z',
            updated_at: '2025-06-27T09:15:00Z'
        },
        {
            uuid: '3',
            name: 'Feature Visualization Dataset',
            artifact_type: 'dataset',
            description: 'Curated dataset for visualizing neural network features',
            authors: [{name: 'Viz Team', email: 'viz@example.com'}],
            version: '1.2.0',
            tags: ['visualization', 'features', 'dataset'],
            downloads: 267,
            stars: 34,
            created_at: '2025-06-10T08:45:00Z',
            updated_at: '2025-06-25T16:20:00Z'
        }
    ];
    filteredArtifacts = [...artifacts];
    renderArtifacts();
}

// Render artifacts in the grid
function renderArtifacts() {
    const container = document.getElementById('artifactsGrid');
    
    if (filteredArtifacts.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No artifacts found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredArtifacts.map(artifact => `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 artifact-card" onclick="viewArtifact('${artifact.uuid}')">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">${artifact.artifact_type.replace('_', ' ').toUpperCase()}</span>
                    <div>
                        <span class="text-muted me-2">
                            <i class="fas fa-download"></i> ${artifact.downloads}
                        </span>
                        <span class="text-warning">
                            <i class="fas fa-star"></i> ${artifact.stars}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${artifact.name}</h5>
                    <p class="card-text">${artifact.description}</p>
                    <div class="mb-2">
                        ${artifact.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                    </div>
                    <small class="text-muted">
                        by ${artifact.authors[0].name} • v${artifact.version} • 
                        ${new Date(artifact.updated_at).toLocaleDateString()}
                    </small>
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100">
                        <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); downloadArtifact('${artifact.uuid}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); viewDetails('${artifact.uuid}')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); starArtifact('${artifact.uuid}')">
                            <i class="fas fa-star"></i> Star
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Load statistics
function loadStats() {
    document.getElementById('totalArtifacts').textContent = artifacts.length;
    document.getElementById('totalDownloads').textContent = artifacts.reduce((sum, a) => sum + a.downloads, 0);
    document.getElementById('totalAuthors').textContent = new Set(artifacts.map(a => a.authors[0].name)).size;
    document.getElementById('totalModels').textContent = new Set(artifacts.flatMap(a => a.tags.filter(t => ['gpt2', 'llama', 'bert'].some(m => t.includes(m))))).size;
}

// Search functionality
function searchArtifacts() {
    const query = document.getElementById('searchQuery').value.toLowerCase();
    filteredArtifacts = artifacts.filter(artifact => 
        artifact.name.toLowerCase().includes(query) ||
        artifact.description.toLowerCase().includes(query) ||
        artifact.tags.some(tag => tag.toLowerCase().includes(query))
    );
    renderArtifacts();
}

// Filter by type
function filterArtifacts() {
    const typeFilter = document.getElementById('typeFilter').value;
    const modelFilter = document.getElementById('modelFilter').value;
    
    filteredArtifacts = artifacts.filter(artifact => {
        const typeMatch = !typeFilter || artifact.artifact_type === typeFilter;
        const modelMatch = !modelFilter || artifact.tags.includes(modelFilter);
        return typeMatch && modelMatch;
    });
    renderArtifacts();
}

// Sort artifacts
function sortArtifacts() {
    const sortBy = document.getElementById('sortBy').value;
    filteredArtifacts.sort((a, b) => {
        switch(sortBy) {
            case 'name': return a.name.localeCompare(b.name);
            case 'downloads': return b.downloads - a.downloads;
            case 'stars': return b.stars - a.stars;
            case 'created_at': return new Date(b.created_at) - new Date(a.created_at);
            default: return new Date(b.updated_at) - new Date(a.updated_at);
        }
    });
    renderArtifacts();
}

// Refresh artifacts
function refreshArtifacts() {
    loadArtifacts();
}

// Upload artifact
function uploadArtifact() {
    new bootstrap.Modal(document.getElementById('uploadModal')).show();
}

// Submit upload
function submitUpload() {
    // Implementation would submit to API
    alert('Upload functionality would be implemented here');
}

// View artifact details
function viewArtifact(uuid) {
    const artifact = artifacts.find(a => a.uuid === uuid);
    if (artifact) {
        alert(`Viewing details for: ${artifact.name}\n\nThis would open a detailed view.`);
    }
}

// Download artifact
function downloadArtifact(uuid) {
    alert(`Downloading artifact ${uuid}...`);
}

// View details
function viewDetails(uuid) {
    alert(`Viewing details for artifact ${uuid}...`);
}

// Star artifact
function starArtifact(uuid) {
    alert(`Starring artifact ${uuid}...`);
}

// Show/hide loading
function showLoading(show) {
    const loading = document.querySelector('.spinner-border');
    if (loading) {
        loading.closest('.col-12').style.display = show ? 'block' : 'none';
    }
}

// CSS for artifact cards
const style = document.createElement('style');
style.textContent = `
    .artifact-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .artifact-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
